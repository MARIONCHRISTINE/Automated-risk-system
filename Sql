SET SQL_MODE = "NO_AUTO_VALUE_ON_ZERO";
START TRANSACTION;
SET time_zone = "+00:00";

-- Drop table if it exists to avoid errors
DROP TABLE IF EXISTS `risk_incidents`;

CREATE TABLE `risk_incidents` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `date_of_risk_entry` date NOT NULL DEFAULT curdate(),
  `existing_or_new` varchar(255) DEFAULT NULL,
  `to_be_reported_to_board` varchar(255) DEFAULT NULL,
  `risk_name` varchar(200) NOT NULL,
  `risk_description` text NOT NULL,
  `cause_of_risk` text NOT NULL,
  `cause_of_risk_description` text DEFAULT NULL,
  `inherent_likelihood` int(11) DEFAULT NULL,
  `inherent_consequence` int(11) DEFAULT NULL,
  `inherent_rating` decimal(3,1) DEFAULT NULL,
  `residual_likelihood` int(11) DEFAULT NULL,
  `residual_consequence` int(11) DEFAULT NULL,
  `residual_rating` decimal(3,1) DEFAULT NULL,
  `risk_rating` decimal(10,2) DEFAULT NULL COMMENT 'Calculated risk rating (likelihood Ã— impact)',
  `treatment_action` text DEFAULT NULL,
  `controls_action_plan` text DEFAULT NULL,
  `planned_completion_date` date DEFAULT NULL,
  `risk_owner_id` int(11) DEFAULT NULL,
  `progress_update_report` text DEFAULT NULL,
  `status` enum('open','in_progress','completed','overdue','closed') DEFAULT 'open',
  `reported_by` int(11) NOT NULL,
  `created_at` timestamp NOT NULL DEFAULT current_timestamp(),
  `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(),
  `updated_by` int(11) DEFAULT NULL,
  `monitoring_frequency` enum('weekly','monthly','quarterly','annually') DEFAULT NULL,
  `next_review_date` date DEFAULT NULL,
  `risk_appetite` text DEFAULT NULL,
  `escalation_criteria` text DEFAULT NULL,
  `progress_update` text DEFAULT NULL,
  `risk_status` enum('Not Started','In Progress','Completed','Overdue') DEFAULT 'Not Started',
  `department_id` int(11) NOT NULL,
  `department` varchar(100) DEFAULT NULL,
  `normalized_department` varchar(100) NOT NULL,
  `department_abbreviation` varchar(10) NOT NULL,
  `collaborators` text DEFAULT NULL,
  `treatment_documents` text DEFAULT NULL,
  `involves_money_loss` varchar(10) DEFAULT NULL COMMENT 'Whether the risk involves money loss',
  `money_amount` decimal(15,2) DEFAULT NULL COMMENT 'Estimated amount of money loss',
  `probability` int(11) DEFAULT NULL COMMENT 'Risk probability (1-5 scale)',
  `impact` int(11) DEFAULT NULL COMMENT 'Risk impact (1-5 scale)',
  `risk_level` varchar(20) DEFAULT 'Not Assessed' COMMENT 'Calculated risk level (Low, Medium, High, Critical)',
  `risk_categories` text DEFAULT NULL COMMENT 'JSON array of selected risk categories',
  `risk_id_number` varchar(50) DEFAULT NULL,
  `controls_action_plans` text DEFAULT NULL,
  `target_completion_date` date DEFAULT NULL,
  `treatment_status` varchar(50) DEFAULT 'Not Started',
  `document_path` varchar(255) DEFAULT NULL,
  `section_b_locked` tinyint(1) NOT NULL DEFAULT 0,
  `section_c_locked` tinyint(1) NOT NULL DEFAULT 0,
  `category_details` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL COMMENT 'Category-specific dropdown selections as JSON object',
  `custom_risk_id` varchar(50) DEFAULT NULL,
  `inherent_risk_level` varchar(50) DEFAULT NULL,
  `residual_risk_level` varchar(50) DEFAULT NULL,
  `general_inherent_risk_level` varchar(50) DEFAULT NULL,
  `general_residual_risk_level` varchar(50) DEFAULT NULL,
  `control_assessment` text DEFAULT NULL,
  `general_inherent_risk_score` decimal(10,2) DEFAULT NULL,
  `general_residual_risk_score` decimal(10,2) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `reported_by` (`reported_by`),
  KEY `idx_risk_owner` (`risk_owner_id`),
  KEY `idx_status` (`status`),
  KEY `idx_inherent_rating` (`inherent_rating`),
  KEY `idx_residual_rating` (`residual_rating`),
  KEY `idx_updated_by` (`updated_by`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_treatment_status` (`treatment_status`),
  KEY `idx_target_completion` (`target_completion_date`),
  KEY `idx_risk_incidents_risk_status` (`risk_status`),
  KEY `idx_risk_categories` (`risk_categories`(255)),
  KEY `idx_department_id` (`department_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

-- Try to add foreign keys (will be ignored if tables don't exist)
-- Note: If these fail, the transaction will continue without them
ALTER TABLE `risk_incidents` 
ADD CONSTRAINT `fk_risk_incidents_department` 
FOREIGN KEY (`department_id`) REFERENCES `departments` (`id`);

ALTER TABLE `risk_incidents` 
ADD CONSTRAINT `risk_incidents_ibfk_1` 
FOREIGN KEY (`reported_by`) REFERENCES `users` (`id`);

ALTER TABLE `risk_incidents` 
ADD CONSTRAINT `risk_incidents_ibfk_3` 
FOREIGN KEY (`risk_owner_id`) REFERENCES `users` (`id`);

ALTER TABLE `risk_incidents` 
ADD CONSTRAINT `risk_incidents_ibfk_4` 
FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL;

COMMIT;
